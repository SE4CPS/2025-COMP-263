
<!doctype html>
<meta charset="utf-8">
<title>IndexedDB Furniture Demo</title>
<script>
const dbOpen = indexedDB.open("furnitureDB", 1);

// Create store on first run
dbOpen.onupgradeneeded = e => {
  e.target.result.createObjectStore("items", { keyPath: "id", autoIncrement: true });
};

dbOpen.onsuccess = async e => {
  const db = e.target.result;

  // Helper: read/write transaction
  const rw = fn => new Promise((ok, er) => {
    const tx = db.transaction("items", "readwrite");
    fn(tx.objectStore("items"));
    tx.oncomplete = ok;
    tx.onerror = () => er(tx.error);
  });

  // Helper: get all items
  const all = () => new Promise(ok => {
    const out = [];
    const cur = db.transaction("items").objectStore("items").openCursor();
    cur.onsuccess = () => {
      let c = cur.result;
      if (c) { out.push(c.value); c.continue(); }
      else { console.log("ALL:", out); ok(out); }
    };
  });

  // --- CRUD demo ---
  await rw(s => {
    s.add({ name: "Chair", price: 49, stock: 10 });
    s.add({ name: "Table", price: 129, stock: 5 });
    s.add({ name: "Sofa",  price: 499, stock: 2 });
  });

  let items = await all();              // READ

  items[0].price = 59;                  // UPDATE first item
  await rw(s => s.put(items[0]));

  await rw(s => s.delete(items[1].id)); // DELETE second item

  await rw(s => s.add({ name: "Lamp", price: 35, stock: 20 })); // CREATE new item

  await all();                          // Final state
  console.log("CRUD demo complete.");
};

dbOpen.onerror = e => console.error("DB open error:", e.target.error);
</script>
